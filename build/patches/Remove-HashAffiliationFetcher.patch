From: uazo <uazo@users.noreply.github.com>
Date: Thu, 27 Jan 2022 16:04:42 +0000
Subject: Remove HashAffiliationFetcher

and fix crash with cct in incognito
---
 .../well_known_change_password_navigation_throttle.cc      | 7 ++++++-
 .../browser/site_affiliation/hash_affiliation_fetcher.cc   | 1 +
 2 files changed, 7 insertions(+), 1 deletion(-)

diff --git a/chrome/browser/ui/passwords/well_known_change_password_navigation_throttle.cc b/chrome/browser/ui/passwords/well_known_change_password_navigation_throttle.cc
--- a/chrome/browser/ui/passwords/well_known_change_password_navigation_throttle.cc
+++ b/chrome/browser/ui/passwords/well_known_change_password_navigation_throttle.cc
@@ -86,7 +86,7 @@ WellKnownChangePasswordNavigationThrottle::
   affiliation_service_ =
       AffiliationServiceFactory::GetForProfile(Profile::FromBrowserContext(
           handle->GetWebContents()->GetBrowserContext()));
-  if (affiliation_service_->GetChangePasswordURL(request_url_).is_empty()) {
+  if (affiliation_service_ && affiliation_service_->GetChangePasswordURL(request_url_).is_empty()) {
     well_known_change_password_state_.PrefetchChangePasswordURLs(
         affiliation_service_, {request_url_});
   }
@@ -152,6 +152,11 @@ const char* WellKnownChangePasswordNavigationThrottle::GetNameForLogging() {
 
 void WellKnownChangePasswordNavigationThrottle::OnProcessingFinished(
     bool is_supported) {
+  if (!affiliation_service_) {
+    Redirect(request_url_.DeprecatedGetOriginAsURL());
+    CancelDeferredNavigation(NavigationThrottle::CANCEL);
+    return;
+  };
   GURL redirect_url = affiliation_service_->GetChangePasswordURL(request_url_);
 
   // If affiliation service returns .well-known/change-password as change
diff --git a/components/password_manager/core/browser/site_affiliation/hash_affiliation_fetcher.cc b/components/password_manager/core/browser/site_affiliation/hash_affiliation_fetcher.cc
--- a/components/password_manager/core/browser/site_affiliation/hash_affiliation_fetcher.cc
+++ b/components/password_manager/core/browser/site_affiliation/hash_affiliation_fetcher.cc
@@ -55,6 +55,7 @@ void HashAffiliationFetcher::StartRequest(
     const std::vector<FacetURI>& facet_uris,
     RequestInfo request_info) {
   requested_facet_uris_ = facet_uris;
+  if ((true)) return;
 
   net::NetworkTrafficAnnotationTag traffic_annotation =
       net::DefineNetworkTrafficAnnotation("affiliation_lookup_by_hash", R"(
-- 
2.25.1

