From: csagan5 <32685696+csagan5@users.noreply.github.com>
Date: Sun, 26 Nov 2017 22:51:43 +0100
Subject: Skip the first run and remove report sending

---
 .../android/java/res/layout/fre_tosanduma.xml | 11 +-----
 chrome/android/java/res/values/dimens.xml     |  1 -
 .../browser/firstrun/FirstRunActivity.java    |  7 ----
 .../firstrun/FirstRunFlowSequencer.java       |  9 ++---
 .../browser/firstrun/FirstRunUtils.java       |  3 --
 .../firstrun/ToSAndUMAFirstRunFragment.java   | 34 +------------------
 .../browser/firstrun/FirstRunStatus.java      |  6 ++--
 7 files changed, 6 insertions(+), 65 deletions(-)

diff --git a/chrome/android/java/res/layout/fre_tosanduma.xml b/chrome/android/java/res/layout/fre_tosanduma.xml
--- a/chrome/android/java/res/layout/fre_tosanduma.xml
+++ b/chrome/android/java/res/layout/fre_tosanduma.xml
@@ -83,16 +83,7 @@
                         android:layout_marginTop="@dimen/fre_vertical_spacing"
                         android:layout_marginBottom="@dimen/fre_tos_bottom_margin"
                         android:lineSpacingMultiplier="1.4"
-                        android:textAppearance="@style/TextAppearance.TextMedium.Primary" />
-
-                    <CheckBox
-                        android:id="@+id/send_report_checkbox"
-                        android:layout_width="wrap_content"
-                        android:layout_height="wrap_content"
-                        android:lineSpacingMultiplier="1.4"
-                        android:text="@string/fre_send_report_check"
-                        android:paddingStart="@dimen/fre_tos_checkbox_padding"
-                        android:textAppearance="@style/TextAppearance.TextMedium.Primary" />
+                        android:textAppearance="@style/TextAppearance.TextMedium.Primary" android:visibility="gone" />
                 </LinearLayout>
 
                 <include
diff --git a/chrome/android/java/res/values/dimens.xml b/chrome/android/java/res/values/dimens.xml
--- a/chrome/android/java/res/values/dimens.xml
+++ b/chrome/android/java/res/values/dimens.xml
@@ -115,7 +115,6 @@
 
     <dimen name="fre_image_bottom_margin">36dp</dimen>
     <dimen name="fre_tos_image_height">110dp</dimen>
-    <dimen name="fre_tos_checkbox_padding">12dp</dimen>
     <dimen name="fre_tos_bottom_margin">16dp</dimen>
     <dimen name="fre_loading_spinner_size">48dp</dimen>
     <dimen name="fre_bottom_loading_spinner_size">24dp</dimen>
diff --git a/chrome/android/java/src/org/chromium/chrome/browser/firstrun/FirstRunActivity.java b/chrome/android/java/src/org/chromium/chrome/browser/firstrun/FirstRunActivity.java
--- a/chrome/android/java/src/org/chromium/chrome/browser/firstrun/FirstRunActivity.java
+++ b/chrome/android/java/src/org/chromium/chrome/browser/firstrun/FirstRunActivity.java
@@ -33,7 +33,6 @@ import org.chromium.chrome.browser.fonts.FontPreloader;
 import org.chromium.chrome.browser.metrics.UmaUtils;
 import org.chromium.chrome.browser.search_engines.TemplateUrlServiceFactory;
 import org.chromium.chrome.browser.signin.SigninFirstRunFragment;
-import org.chromium.chrome.browser.signin.services.FREMobileIdentityConsistencyFieldTrial;
 import org.chromium.components.browser_ui.modaldialog.AppModalPresenter;
 import org.chromium.ui.base.LocalizationUtils;
 import org.chromium.ui.modaldialog.ModalDialogManager;
@@ -144,9 +143,6 @@ public class FirstRunActivity extends FirstRunActivityBase implements FirstRunPa
     /** Creates first page and sets up adapter. Should result UI being shown on the screen. */
     private void createFirstPage() {
         BooleanSupplier showWelcomePage = () -> !FirstRunStatus.shouldSkipWelcomePage();
-        if (FREMobileIdentityConsistencyFieldTrial.isEnabled()) {
-            mPages.add(new FirstRunPage<>(SigninFirstRunFragment.class, showWelcomePage));
-        } else {
             // TODO(crbug.com/1111490): Revisit during post-MVP.
             // There's an edge case where we accept the welcome page in the main app, abort the FRE,
             // then go through this CCT FRE again.
@@ -155,7 +151,6 @@ public class FirstRunActivity extends FirstRunActivityBase implements FirstRunPa
                                     TosAndUmaFirstRunFragmentWithEnterpriseSupport.class,
                                     showWelcomePage)
                             : new FirstRunPage<>(ToSAndUMAFirstRunFragment.class, showWelcomePage));
-        }
         mFreProgressStates.add(MobileFreProgress.WELCOME_SHOWN);
         mPagerAdapter = new FirstRunPagerAdapter(FirstRunActivity.this, mPages);
         mPager.setAdapter(mPagerAdapter);
@@ -245,8 +240,6 @@ public class FirstRunActivity extends FirstRunActivityBase implements FirstRunPa
     public void triggerLayoutInflation() {
         // Generate trial group as early as possible to guarantee it's available by the time native
         // needs to register the synthetic trial group. See https://crbug.com/1295692 for details.
-        FREMobileIdentityConsistencyFieldTrial.createFirstRunTrial();
-
         initializeStateFromLaunchData();
         RecordHistogram.recordTimesHistogram("MobileFre.FromLaunch.TriggerLayoutInflation",
                 SystemClock.elapsedRealtime() - mIntentCreationElapsedRealtimeMs);
diff --git a/chrome/android/java/src/org/chromium/chrome/browser/firstrun/FirstRunFlowSequencer.java b/chrome/android/java/src/org/chromium/chrome/browser/firstrun/FirstRunFlowSequencer.java
--- a/chrome/android/java/src/org/chromium/chrome/browser/firstrun/FirstRunFlowSequencer.java
+++ b/chrome/android/java/src/org/chromium/chrome/browser/firstrun/FirstRunFlowSequencer.java
@@ -85,10 +85,7 @@ public abstract class FirstRunFlowSequencer  {
         /** @return true if the Search Engine promo page should be shown. */
         @VisibleForTesting
         public boolean shouldShowSearchEnginePage() {
-            @SearchEnginePromoType
-            int searchPromoType = LocaleManager.getInstance().getSearchEnginePromoShowType();
-            return searchPromoType == SearchEnginePromoType.SHOW_NEW
-                    || searchPromoType == SearchEnginePromoType.SHOW_EXISTING;
+            return false;
         }
 
         /** @return true if Sync is allowed for the current user. */
@@ -103,9 +100,7 @@ public abstract class FirstRunFlowSequencer  {
         /** @return true if first use hints should be skipped. */
         @VisibleForTesting
         protected boolean shouldSkipFirstUseHints(Activity activity) {
-            return Settings.Secure.getInt(
-                           activity.getContentResolver(), Settings.Secure.SKIP_FIRST_USE_HINTS, 0)
-                    != 0;
+            return true;
         }
     }
 
diff --git a/chrome/android/java/src/org/chromium/chrome/browser/firstrun/FirstRunUtils.java b/chrome/android/java/src/org/chromium/chrome/browser/firstrun/FirstRunUtils.java
--- a/chrome/android/java/src/org/chromium/chrome/browser/firstrun/FirstRunUtils.java
+++ b/chrome/android/java/src/org/chromium/chrome/browser/firstrun/FirstRunUtils.java
@@ -43,15 +43,12 @@ public class FirstRunUtils {
         boolean javaPrefValue =
                 javaPrefs.readBoolean(ChromePreferenceKeys.FIRST_RUN_CACHED_TOS_ACCEPTED, false);
         boolean nativePrefValue = isFirstRunEulaAccepted();
-        boolean isFirstRunComplete = FirstRunStatus.getFirstRunFlowComplete();
-        if (javaPrefValue || nativePrefValue || isFirstRunComplete) {
             if (!javaPrefValue) {
                 javaPrefs.writeBoolean(ChromePreferenceKeys.FIRST_RUN_CACHED_TOS_ACCEPTED, true);
             }
             if (!nativePrefValue) {
                 setEulaAccepted();
             }
-        }
     }
 
     /**
diff --git a/chrome/android/java/src/org/chromium/chrome/browser/firstrun/ToSAndUMAFirstRunFragment.java b/chrome/android/java/src/org/chromium/chrome/browser/firstrun/ToSAndUMAFirstRunFragment.java
--- a/chrome/android/java/src/org/chromium/chrome/browser/firstrun/ToSAndUMAFirstRunFragment.java
+++ b/chrome/android/java/src/org/chromium/chrome/browser/firstrun/ToSAndUMAFirstRunFragment.java
@@ -62,7 +62,6 @@ public class ToSAndUMAFirstRunFragment
     private boolean mAllowCrashUpload;
 
     private Button mAcceptButton;
-    private CheckBox mSendReportCheckBox;
     private TextView mTosAndPrivacy;
     private View mTitle;
     private View mProgressSpinner;
@@ -89,13 +88,10 @@ public class ToSAndUMAFirstRunFragment
         mProgressSpinner = view.findViewById(R.id.progress_spinner);
         mProgressSpinner.setVisibility(View.GONE);
         mAcceptButton = (Button) view.findViewById(R.id.terms_accept);
-        mSendReportCheckBox = (CheckBox) view.findViewById(R.id.send_report_checkbox);
         mTosAndPrivacy = (TextView) view.findViewById(R.id.tos_and_privacy);
 
         // Register event listeners.
         mAcceptButton.setOnClickListener((v) -> onTosButtonClicked());
-        mSendReportCheckBox.setOnCheckedChangeListener(
-                ((compoundButton, isChecked) -> mAllowCrashUpload = isChecked));
 
         // Make TextView links clickable.
         mTosAndPrivacy.setMovementMethod(LinkMovementMethod.getInstance());
@@ -133,11 +129,6 @@ public class ToSAndUMAFirstRunFragment
         if (!isVisibleToUser) {
             // Restore original enabled & visibility states, in case the user returns to the page.
             setSpinnerVisible(false);
-        } else {
-            // On certain versions of Android, the checkbox will appear unchecked upon revisiting
-            // the page.  Force it to the end state of the drawable animation as a work around.
-            // crbug.com/666258
-            mSendReportCheckBox.jumpDrawablesToCurrentState();
         }
     }
 
@@ -164,7 +155,6 @@ public class ToSAndUMAFirstRunFragment
         assert !isWaitingForNativeAndPolicyInit();
 
         setSpinnerVisible(false);
-        mSendReportCheckBox.setChecked(mAllowCrashUpload);
     }
 
     /** Implements {@link FreUMADialogCoordinator.Listener} */
@@ -181,14 +171,10 @@ public class ToSAndUMAFirstRunFragment
 
         final boolean umaDialogMayBeShown =
                 FREMobileIdentityConsistencyFieldTrial.shouldShowOldFreWithUmaDialog();
-        final boolean hasChildAccount = getPageDelegate().getProperties().getBoolean(
-                SyncConsentFirstRunFragment.IS_CHILD_ACCOUNT, false);
         final boolean isMetricsReportingDisabledByPolicy = !isWaitingForNativeAndPolicyInit()
                 && PrivacyPreferencesManagerImpl.getInstance().isMetricsReportingDisabledByPolicy();
 
-        updateTosText(umaDialogMayBeShown, hasChildAccount, isMetricsReportingDisabledByPolicy);
-
-        updateReportCheckbox(umaDialogMayBeShown, isMetricsReportingDisabledByPolicy);
+        updateTosText(umaDialogMayBeShown, false, isMetricsReportingDisabledByPolicy);
     }
 
     private SpanInfo buildTermsOfServiceLink() {
@@ -264,20 +250,6 @@ public class ToSAndUMAFirstRunFragment
         mTosAndPrivacy.setText(SpanApplier.applySpans(tosString, spans.toArray(new SpanInfo[0])));
     }
 
-    private void updateReportCheckbox(
-            boolean umaDialogMayBeShown, boolean isMetricsReportingDisabledByPolicy) {
-        mAllowCrashUpload = getUmaCheckBoxInitialState();
-        mSendReportCheckBox.setChecked(mAllowCrashUpload);
-
-        if (!canShowUmaCheckBox()) {
-            if (!umaDialogMayBeShown) {
-                mAllowCrashUpload = (sShowUmaCheckBoxForTesting || VersionInfo.isOfficialBuild())
-                        && !isMetricsReportingDisabledByPolicy;
-            }
-            mSendReportCheckBox.setVisibility(View.GONE);
-        }
-    }
-
     private void openUmaDialog() {
         new FreUMADialogCoordinator(requireContext(),
                 ((ModalDialogManagerHolder) getActivity()).getModalDialogManager(), this,
@@ -372,10 +344,6 @@ public class ToSAndUMAFirstRunFragment
 
         mAcceptButton.setVisibility(visibility);
         mTosAndPrivacy.setVisibility(visibility);
-        // Avoid updating visibility if the UMA check box can't be shown right now.
-        if (canShowUmaCheckBox()) {
-            mSendReportCheckBox.setVisibility(visibility);
-        }
     }
 
     protected View getToSAndPrivacyText() {
diff --git a/chrome/browser/first_run/android/java/src/org/chromium/chrome/browser/firstrun/FirstRunStatus.java b/chrome/browser/first_run/android/java/src/org/chromium/chrome/browser/firstrun/FirstRunStatus.java
--- a/chrome/browser/first_run/android/java/src/org/chromium/chrome/browser/firstrun/FirstRunStatus.java
+++ b/chrome/browser/first_run/android/java/src/org/chromium/chrome/browser/firstrun/FirstRunStatus.java
@@ -43,8 +43,7 @@ public class FirstRunStatus {
      * includes ToS and Sign In pages if necessary.
      */
     public static boolean getFirstRunFlowComplete() {
-        return SharedPreferencesManager.getInstance().readBoolean(
-                ChromePreferenceKeys.FIRST_RUN_FLOW_COMPLETE, false);
+        return true;
     }
 
     /**
@@ -61,8 +60,7 @@ public class FirstRunStatus {
      * Checks whether the welcome page should be skipped from the main First Run Experience.
      */
     public static boolean shouldSkipWelcomePage() {
-        return SharedPreferencesManager.getInstance().readBoolean(
-                ChromePreferenceKeys.FIRST_RUN_SKIP_WELCOME_PAGE, false);
+        return true;
     }
 
     /**
--
2.25.1
